{% extends "yuzzaz/besa.html" %}
{% load static %}
{% block title %}{{ product.name }}{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/shop.css' %}">
{% endblock %}
{% block section %}{{ product.name }}{% endblock %}
{% block content %}
<div class="login-container">

    <!-- Illustration Side -->
    <div class="illustration-side">
        <!-- Main Image -->
        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="main-image">
        <br>
    
        <!-- Additional Images -->
        <div class="auto" style="display: flex; flex-direction: row; margin: 20px 0 20px 0; gap: 10px;">
            <br>
            <style>
                .main-imagee {
                    width: 150px;
                    cursor: pointer;
                }
    
                @media (max-width: 1024px) {
                    .auto {
                        width: 350px;
                        overflow-x: scroll;
                    }
                }
            </style>
    
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="main-imagee">
    
            {% if product.image_2 %}
                <img src="{{ product.image_2.url }}" alt="{{ product.name }}" class="main-imagee">
            {% endif %}
            {% if product.image_3 %}
                <img src="{{ product.image_3.url }}" alt="{{ product.name }}" class="main-imagee">
            {% endif %}
            {% if product.image_4 %}
                <img src="{{ product.image_4.url }}" alt="{{ product.name }}" class="main-imagee">
            {% endif %}
        </div>
    </div>
    

    <!-- Form Side -->
    <div class="form-side">
        <div class="login-form" method="POST">
            <!-- <form class="login-form" method="post" action="{% url 'login' %}"> -->
            {% csrf_token %}
            <div class="form-header">
                {% if product.status == 'sold_out' %}
                <span class="sold-out-badge">SOLD OUT</span>
                <br>
                {% endif %}
                <h4>{{ product.name }}</h4>
                <h5>TZS. <u>{{ product.price }}</u></h5>
                <h6 style="margin: 0;">{{ product.description }}</h6>
                <small>ALL ITEMS IN STOCK. READY TO SHIP </small>

                <!-- Size Selection -->
                <div class="size-section">
                    <br>
                    <p class="fw-bold">AVAILABLE SizeS:</p>

                    {% if product.size_s %}
                    <button type="submit" name="size" value="S" class="size-btn">S</button>
                    {% endif %}
                    {% if product.size_m %}
                    <button type="submit" name="size" value="M" class="size-btn">M</button>
                    {% endif %}
                    {% if product.size_l %}
                    <button type="submit" name="size" value="L" class="size-btn">L</button>
                    {% endif %}
                    {% if product.size_xl %}
                    <button type="submit" name="size" value="XL" class="size-btn">XL</button>
                    {% endif %}
                    {% if product.size_xxl %}
                    <button type="submit" name="size" value="XXL" class="size-btn">XXL</button>
                    {% endif %}
                    <br>

                </div>
                <br>

                <!-- Order Tracking -->
                <div class="order-tracking">
                    <div class="step">
                        <div class="round">

                            <i class="bi bi-bag-check"></i>
                        </div>
                        <p class="fw-bold">Ordered</p>
                        <p>{{ ordered_date|date:"M d" }}</p>
                    </div>
                    <div class="line"></div>
                    <div class="step">
                        <div class="round">

                            <i class="bi bi-truck"></i>
                        </div>
                        <p class="fw-bold">Ready</p>
                        <p>{{ order_ready_date|date:"M d" }}</p>
                    </div>
                    <div class="line"></div>
                    <div class="step">
                        <div class="round">

                            <i class="bi bi-geo-alt"></i>
                        </div>
                        <p class="fw-bold">Delivered</p>

                        <p>{{ delivered_date|date:"M d" }}</p>
                    </div>
                </div>

                <style>
                    .order-tracking {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        text-align: center;
                        margin: 20px auto;
                        max-width: 500px;
                    }

                    .step {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        width: 100px;
                    }

                    .round {
                        font-size: 24px;
                        background: black;
                        color: white;
                        border-radius: 100%;
                        padding: 12px;
                        margin-bottom: 5px;
                        width: 60px;
                        height: 60px;
                    }

                    .step p {
                        margin: 2px 0;
                        font-size: 14px;
                    }

                    .fw-bold {
                        font-weight: bold;
                    }

                    .line {
                        flex-grow: 1;
                        height: 3px;
                        background: black;
                        margin: 0 10px;
                    }
                </style>
            </div>

            <button class="submit-btn" id="details" data-bs-toggle="modal"
            data-bs-target="#productModal{{ product.id }}">
                <span class="btn-text">
                <a href="{% url 'add_to_cart' product.id %}">
                    Order Now
                </a>    
                </span>
            </button>

            <div class="form-footer">
                <p>Back to <a href="{% url 'homepage' %}"><u>BASICS</u></a></p>
            </div>
        </div>
    </div>
</div>

      <!-- Enhanced Modal -->
      <div class="modal fade" id="productModal{{ product.id }}" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content border-0 shadow-lgk">
            <!-- Modal Header -->
            <div class="modal-header border-0 pb-0">
              <h5 class="modal-title fw-bold fs-4">Order Now</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
              <div class="row g-4">
                <!-- Left Column: Carousel and Product Details -->
                <div class="col-lg-6 pe-lg-4">
                  <!-- Enhanced Carousel -->
                  <div id="productCarousel{{ product.id }}" class="carousel slide" data-bs-ride="carousel">

                  <!-- Product Details -->
                  <div class="mt-4 p-4 border rounded shadow-sm bg-white">
                    <h3 class="fw-bold text-secondary">{{ product.name }}</h3>
                    <button type="submit" class="btn btn-primary" style="width: fit-content;">
                      <!-- <i class="bi bi-cash"></i>  -->
                      <i class="bi bi-cash-45deg"></i>

                      TZS {{ product.price|floatformat:2 }}
                    </button>
                    
                    <!-- <h5 class="text-success fw-semibold mt-2"></h5> -->

                    <p class="text-muted mt-3"><strong>Description:</strong> {{ product.description }}</p>

                    <div class="mt-2">
                      <small class="text-body-secondary d-flex align-items-center">
                        {% if product.average_rating >= 0.5 %}
                        {% with ''|center:product.average_rating as range %}
                        {% for _ in range %} <span class="text-warning fs-5">⭐</span> {% endfor %}
                        {% endwith %}
                        <span class="ms-2 fw-medium">{{ product.average_rating|floatformat:1 }}/5</span>
                        {% else %}
                        <span class="text-muted">No rating yet</span>
                        {% endif %}
                      </small>
                    </div>
                  </div>

                </div>

                <!-- Right Column: Reviews and Rating -->
                <div class="col-lg-6 ps-lg-4">
                  <div class="sticky-top" style="top: 1rem;">
                    {% if user.is_authenticated %}
                    <!-- Rating Section -->
                    <div class="card border-0 bg-light p-3 mb-4 shadow-sm">
                      <h6 class="fw-bold mb-3">Rate this product</h6>
                      <form method="POST" action="{% url 'add_rating' product.id %}">
                        {% csrf_token %}
                        <select name="stars" class="form-select mb-3">
                          <option value="5">5 ⭐⭐⭐⭐⭐</option>
                          <option value="4">4 ⭐⭐⭐⭐</option>
                          <option value="3">3 ⭐⭐⭐</option>
                          <option value="2">2 ⭐⭐</option>
                          <option value="1">1 ⭐</option>
                        </select>
                        <!-- <button type="submit" class="btn btn-primary w-100">Submit Rating</button> -->
                        <button type="submit" class="submit-btn">
                          <span class="btn-text">Submit Rating</span>
                      </button>
                      
                      </form>
                    </div>

                    <!-- Reviews Section -->
                    <div class="reviews-section">
                      <h6 class="fw-bold mb-3">Reviews</h6>
                      <div class="reviews-container mb-3" style="max-height: 200px; overflow-y: auto;">
                        {% for review in product.reviews.all %}
                        <div class="review-item mb-3 p-3 bg-light rounded-3">
                          <div class="d-flex align-items-center mb-2">
                            <strong class="me-2">{{ review.user.get_full_name }}</strong>
                            <small class="text-muted">{{ review.created_at|timesince }} ago</small>
                          </div>
                          <p class="mb-0">{{ review.comment }}</p>
                        </div>
                        {% empty %}
                        <p class="text-muted mb-0">Be the first to review this product!</p>
                        {% endfor %}
                      </div>

                      <!-- Add Review Form -->
                      <form method="POST" action="{% url 'add_review' product.id %}" class="mt-3">
                        {% csrf_token %}
                        <div class="input-group">
                          <textarea class="form-control" name="comment" rows="2" placeholder="Share your thoughts..."
                            required></textarea>
                          <button type="submit" class="btn btn-primary" style="width: fit-content;">
                            Comment 
                            <i class="bi bi-send-fill"></i> 
                          </button>
                          
                        </div>
                      </form>
                    </div>
                    {% else %}
                    <!-- Login Prompt -->
                    <div class="text-center py-4">
                      <p class="mb-3">Sign in to rate and review this product</p>
                      <a href="{% url 'login' %}" class="btn btn-outline-primary">Login</a>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
<div class="container my-5">
    <h1 style="text-align: start; margin-bottom: 20px;">You may also like...</h1>
    <div class="row row-cols-2 row-cols-md-4 g-4">
        {% for product in random_products %}

        <div class="col">
            <div class="card h-100">
                {% if product.status == 'sold_out' %}
                <span class="sold-out-badge">SOLD OUT</span>
                {% endif %}

                <div class="imeji">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="card-img-top">
                </div>

                <div class="card-body">
                    <a href="{% url 'product_detail' product.id %}">
                        <h5 class="card-title">{{ product.name }}</h5>
                    </a>
                    <p class="card-text">TZS. {{ product.price }}</p>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col">
            <div class="card h-100">
                <div class="imeji">
                    <img src="{% static 'assets/images/single-image-2.jpg' %}" class="card-img-top"
                        alt="Navy Blue Core Hoodie">
                </div>
                <div class="card-body">
                    <h5 class="card-title">SOMETHING GOOD INCOMING</h5>
                    <p class="card-text">TZS. 0.00</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Toast Messages -->
{% if messages %}
<div class="fixed-toast-container">
    {% for message in messages %}
    <div class="toast-message {% if message.tags %}{{ message.tags }}{% endif %}">
        <div class="toast-content">
            <div class="toast-text">{{ message }}</div>
            <button type="button" class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="toast-progress">
            <div class="progress-bar"></div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Scripts -->
<script src="{% static 'js/login.js' %}"></script>
{% endblock %}